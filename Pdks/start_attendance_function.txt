---------------------------------------------------Green_face_recognition_function--------------------------------------------------
def start_attendance():
    cap = cv2.VideoCapture(0)
    messagebox.showinfo("Bilgi", "GÄ°RÄ°Åž kaydÄ± baÅŸladÄ±. Bilinen yÃ¼zler otomatik GÄ°RÄ°Åž yapÄ±lÄ±r.\nBilinmeyen yÃ¼z iÃ§in 'P', Ã§Ä±kÄ±ÅŸ iÃ§in 'Q' tuÅŸu kullanÄ±labilir.")

    known_encodings = []
    known_names = []

    for filename in os.listdir("known_faces"):
        if filename.lower().endswith((".jpg", ".jpeg", ".png")):
            path = os.path.join("known_faces", filename)
            image = face_recognition.load_image_file(path)
            encodings = face_recognition.face_encodings(image)
            if encodings:
                known_encodings.append(encodings[0])
                known_names.append(os.path.splitext(filename)[0])

    last_recorded_name = None

    while True:
        ret, frame = cap.read()
        if not ret:
            messagebox.showerror("Hata", "Kamera gÃ¶rÃ¼ntÃ¼sÃ¼ alÄ±namadÄ±.")
            break

        rgb_frame = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)
        face_locations = face_recognition.face_locations(rgb_frame)
        face_encodings = face_recognition.face_encodings(rgb_frame, face_locations)

        current_names = []

        for (top, right, bottom, left), face_encoding in zip(face_locations, face_encodings):
            matches = face_recognition.compare_faces(known_encodings, face_encoding, tolerance=0.5)
            name = "Bilinmeyen"

            if True in matches:
                first_match_index = matches.index(True)
                name = known_names[first_match_index]

            current_names.append(name)

            # Ekranda Ã§izim
            cv2.rectangle(frame, (left, top), (right, bottom), (0, 255, 0), 2)
            cv2.rectangle(frame, (left, bottom - 20), (right, bottom), (0, 255, 0), cv2.FILLED)
            cv2.putText(frame, name, (left + 6, bottom - 6),
                        cv2.FONT_HERSHEY_DUPLEX, 0.6, (0, 0, 0), 1)

            # Bilinen ve son kayÄ±ttan farklÄ± ise kayÄ±t yap
            if name != "Bilinmeyen" and name != last_recorded_name:
                now = datetime.datetime.now()
                date_str = now.strftime("%d.%m.%Y")
                time_str = now.strftime("%H:%M:%S")

                with open("yoklama.csv", "a", newline="", encoding="utf-8-sig") as file:
                    writer = csv.writer(file)
                    writer.writerow([name, time_str, date_str, "GiriÅŸ"])

                messagebox.showinfo("Yoklama", f"{name} iÃ§in GÄ°RÄ°Åž iÅŸlemi kaydedildi.")
                last_recorded_name = name

        cv2.imshow("Giris Kamerasi (Bilinmeyen icin P, Cikis icin Q)", frame)
        key = cv2.waitKey(1) & 0xFF

        # Bilinmeyen kiÅŸi iÃ§in kayÄ±t
        if key == ord('p'):
            if len(face_encodings) != 1:
                messagebox.showwarning("UyarÄ±", "LÃ¼tfen yalnÄ±zca bir yÃ¼zle kameraya bakÄ±n.")
                continue

            face_encoding = face_encodings[0]
            matches = face_recognition.compare_faces(known_encodings, face_encoding, tolerance=0.5)
            name = "Bilinmeyen"

            if True in matches:
                continue  # Zaten biliniyor, tekrar kayÄ±t etme

            name_input = simpledialog.askstring("Yeni KiÅŸi", "Bilinmeyen yÃ¼z tespit edildi. Ä°sim Soyisim girin:")
            if not name_input or len(name_input.strip().split()) < 2:
                messagebox.showerror("Hata", "GeÃ§ersiz isim.")
                continue

            name = name_input.strip()
            filename = f"{name}.jpg"
            filepath = os.path.join("known_faces", filename)
            cv2.imwrite(filepath, frame)
            messagebox.showinfo("KayÄ±t BaÅŸarÄ±lÄ±", f"{name} klasÃ¶re eklendi.")

            known_encodings.append(face_encoding)
            known_names.append(name)

            now = datetime.datetime.now()
            date_str = now.strftime("%d.%m.%Y")
            time_str = now.strftime("%H:%M:%S")

            with open("yoklama.csv", "a", newline="", encoding="utf-8-sig") as file:
                writer = csv.writer(file)
                writer.writerow([name, time_str, date_str, "GiriÅŸ"])

            messagebox.showinfo("Yoklama", f"{name} iÃ§in GÄ°RÄ°Åž iÅŸlemi kaydedildi.")
            last_recorded_name = name

        elif key == ord('q'):
            break

    cap.release()
    cv2.destroyAllWindows()
-----------------------------------------------------default function--------------------------------------------------
def start_attendance():
    cap = cv2.VideoCapture(0)
    messagebox.showinfo("Bilgi", "GÄ°RÄ°Åž kaydÄ± baÅŸladÄ±. Bilinen yÃ¼zler otomatik GÄ°RÄ°Åž yapÄ±lÄ±r.\nBilinmeyen yÃ¼z iÃ§in 'P', Ã§Ä±kÄ±ÅŸ iÃ§in 'Q' tuÅŸu kullanÄ±labilir.")

    known_encodings = []
    known_names = []

    for filename in os.listdir("known_faces"):
        if filename.lower().endswith((".jpg", ".jpeg", ".png")):
            path = os.path.join("known_faces", filename)
            image = face_recognition.load_image_file(path)
            encodings = face_recognition.face_encodings(image)
            if encodings:
                known_encodings.append(encodings[0])
                known_names.append(os.path.splitext(filename)[0])

    last_recorded_name = None
    frame_count = 0  # ðŸ‘ˆ Frame sayacÄ±

    while True:
        ret, frame = cap.read()
        if not ret:
            messagebox.showerror("Hata", "Kamera gÃ¶rÃ¼ntÃ¼sÃ¼ alÄ±namadÄ±.")
            break

        frame_count += 1
        if frame_count % 5 != 0:
            # Sadece her 5 karede bir iÅŸlem yap
            cv2.imshow("Giris Kamerasi (Bilinmeyen icin P, Cikis icin Q)", frame)
            key = cv2.waitKey(1) & 0xFF
            if key == ord('q'):
                break
            continue

        small_frame = cv2.resize(frame, (0, 0), fx=0.25, fy=0.25)  # ðŸ‘ˆ GÃ¶rÃ¼ntÃ¼yÃ¼ kÃ¼Ã§Ã¼lt
        rgb_small_frame = cv2.cvtColor(small_frame, cv2.COLOR_BGR2RGB)

        face_locations = face_recognition.face_locations(rgb_small_frame, model='hog')
        face_encodings = face_recognition.face_encodings(rgb_small_frame, face_locations)

        current_names = []

        for (top, right, bottom, left), face_encoding in zip(face_locations, face_encodings):
            matches = face_recognition.compare_faces(known_encodings, face_encoding, tolerance=0.5)
            name = "Bilinmeyen"

            if True in matches:
                first_match_index = matches.index(True)
                name = known_names[first_match_index]

            current_names.append(name)

            # KoordinatlarÄ± geri bÃ¼yÃ¼t (Ã§Ã¼nkÃ¼ kÃ¼Ã§Ã¼ltmÃ¼ÅŸtÃ¼k)
            top *= 4
            right *= 4
            bottom *= 4
            left *= 4

            # Ekranda Ã§izim
            cv2.rectangle(frame, (left, top), (right, bottom), (0, 255, 0), 2)
            cv2.rectangle(frame, (left, bottom - 20), (right, bottom), (0, 255, 0), cv2.FILLED)
            cv2.putText(frame, name, (left + 6, bottom - 6),
                        cv2.FONT_HERSHEY_DUPLEX, 0.6, (0, 0, 0), 1)

            # Bilinen ve son kayÄ±ttan farklÄ± ise kayÄ±t yap
            if name != "Bilinmeyen" and name != last_recorded_name:
                now = datetime.datetime.now()
                date_str = now.strftime("%d.%m.%Y")
                time_str = now.strftime("%H:%M:%S")

                with open("yoklama.csv", "a", newline="", encoding="utf-8-sig") as file:
                    writer = csv.writer(file)
                    writer.writerow([name, time_str, date_str, "GiriÅŸ"])

                messagebox.showinfo("Yoklama", f"{name} iÃ§in GÄ°RÄ°Åž iÅŸlemi kaydedildi.")
                last_recorded_name = name

        cv2.imshow("Giris Kamerasi (Bilinmeyen icin P, Cikis icin Q)", frame)
        key = cv2.waitKey(1) & 0xFF

        if key == ord('p'):
            if len(face_encodings) != 1:
                messagebox.showwarning("UyarÄ±", "LÃ¼tfen yalnÄ±zca bir yÃ¼zle kameraya bakÄ±n.")
                continue

            face_encoding = face_encodings[0]
            matches = face_recognition.compare_faces(known_encodings, face_encoding, tolerance=0.5)
            name = "Bilinmeyen"

            if True in matches:
                continue  # Zaten biliniyor, tekrar kayÄ±t etme

            name_input = simpledialog.askstring("Yeni KiÅŸi", "Bilinmeyen yÃ¼z tespit edildi. Ä°sim Soyisim girin:")
            if not name_input or len(name_input.strip().split()) < 2:
                messagebox.showerror("Hata", "GeÃ§ersiz isim.")
                continue

            name = name_input.strip()
            filename = f"{name}.jpg"
            filepath = os.path.join("known_faces", filename)
            cv2.imwrite(filepath, frame)
            messagebox.showinfo("KayÄ±t BaÅŸarÄ±lÄ±", f"{name} klasÃ¶re eklendi.")
            known_encodings.append(face_encoding)
            known_names.append(name)

            now = datetime.datetime.now()
            date_str = now.strftime("%d.%m.%Y")
            time_str = now.strftime("%H:%M:%S")

            with open("yoklama.csv", "a", newline="", encoding="utf-8-sig") as file:
                writer = csv.writer(file)
                writer.writerow([name, time_str, date_str, "GiriÅŸ"])

            messagebox.showinfo("Yoklama", f"{name} iÃ§in GÄ°RÄ°Åž iÅŸlemi kaydedildi.")
            last_recorded_name = name

        elif key == ord('q'):
            break

    cap.release()
    cv2.destroyAllWindows()
